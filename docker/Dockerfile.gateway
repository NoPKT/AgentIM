# Gateway Dockerfile with node-pty native dependencies
# ── Build stage ──
FROM node:20-bookworm-slim AS build
RUN npm install -g pnpm@10

# Install native build dependencies for node-pty
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files first (better layer caching)
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml .npmrc ./
COPY packages/shared/package.json packages/shared/
COPY packages/gateway/package.json packages/gateway/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source
COPY tsconfig.base.json ./
COPY packages/shared/ packages/shared/
COPY packages/gateway/ packages/gateway/

# Build
RUN pnpm --filter @agentim/shared build && pnpm --filter agentim build

# ── Production stage ──
FROM node:20-bookworm-slim AS production
RUN npm install -g pnpm@10

WORKDIR /app

# Copy package files
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml .npmrc ./
COPY packages/shared/package.json packages/shared/
COPY packages/gateway/package.json packages/gateway/

# Install production dependencies only (node-pty needs native libs at runtime)
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    && pnpm install --prod --frozen-lockfile \
    && apt-get purge -y python3 make g++ \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/*

# Copy built artifacts
COPY --from=build /app/packages/shared/dist packages/shared/dist
COPY --from=build /app/packages/gateway/dist packages/gateway/dist

# Create non-root user
RUN addgroup --system app && adduser --system --ingroup app app
USER app

ENV NODE_ENV=production

CMD ["node", "packages/gateway/dist/cli.js", "daemon"]
