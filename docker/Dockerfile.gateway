# Gateway Dockerfile
# ── Build stage ──
FROM node:25-alpine AS build
RUN npm install -g pnpm@10.29.3

WORKDIR /app

# Copy package files first (better layer caching)
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml .npmrc ./
COPY packages/shared/package.json packages/shared/
COPY packages/gateway/package.json packages/gateway/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source
COPY tsconfig.base.json ./
COPY packages/shared/ packages/shared/
COPY packages/gateway/ packages/gateway/

# Build
RUN pnpm --filter @agentim/shared build && pnpm --filter agentim build

# ── Production stage ──
FROM node:25-alpine AS production
RUN npm install -g pnpm@10.29.3

WORKDIR /app

# Copy package files
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml .npmrc ./
COPY packages/shared/package.json packages/shared/
COPY packages/gateway/package.json packages/gateway/

# Install production dependencies only
RUN pnpm install --prod --frozen-lockfile

# Copy built artifacts
COPY --from=build /app/packages/shared/dist packages/shared/dist
COPY --from=build /app/packages/gateway/dist packages/gateway/dist

# Create non-root user
RUN addgroup -S app && adduser -S app -G app
USER app

ENV NODE_ENV=production

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD pgrep -f "node.*cli.js" > /dev/null || exit 1

CMD ["node", "packages/gateway/dist/cli.js", "daemon"]
