#!/bin/sh

# Pre-push hook: run the same checks as CI before pushing.
# Skip with: git push --no-verify (use sparingly)

echo "[pre-push] Running local CI validation..."

# 1. Formatting
echo "[pre-push] Checking formatting..."
pnpm prettier --check "packages/*/src/**/*.{ts,tsx}" || exit 1

# 2. Linting
echo "[pre-push] Running ESLint..."
pnpm eslint packages/*/src/ || exit 1

# 3. Build
echo "[pre-push] Building..."
pnpm build || exit 1

# 4. Unit tests (no external dependencies)
echo "[pre-push] Running shared tests..."
pnpm --filter @agentim/shared test || exit 1

echo "[pre-push] Running gateway tests..."
pnpm --filter agentim test || exit 1

# 5. Web tests (no external dependencies)
echo "[pre-push] Running web tests..."
pnpm --filter @agentim/web test:coverage || exit 1

# 6. Server integration tests (require PostgreSQL + Redis)
if pg_isready -h localhost -p 5432 -q 2>/dev/null && redis-cli -h localhost -p 6379 ping >/dev/null 2>&1; then
  echo "[pre-push] Running server tests (PostgreSQL + Redis detected)..."
  pnpm --filter @agentim/server test:coverage || exit 1
else
  echo "[pre-push] WARN: Skipping server tests (PostgreSQL or Redis not running)"
  echo "[pre-push] Start Docker services for full local validation"
fi

echo "[pre-push] All checks passed!"
